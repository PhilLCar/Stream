#include <processstream.h>

#define TYPENAME ProcessStream

////////////////////////////////////////////////////////////////////////////////
ProcessStream *_(Construct)(FILE *stream)
{
  return (ProcessStream*)CharStream_Construct(BASE(0), stream);
}

////////////////////////////////////////////////////////////////////////////////
void _(Destruct)()
{
  CharStream_Destruct(BASE(0));
}

////////////////////////////////////////////////////////////////////////////////
ProcessStream *STATIC (Open)(const char *name, AccessModes mode)
{
  char buffer[8];

  Stream_Mode(mode, buffer);

  return NEW (ProcessStream) (popen(name, buffer));
}

////////////////////////////////////////////////////////////////////////////////
void _(Close)()
{
  if (BASE(1)->cod)
  {
    pclose(*BASE(2));
  }
}

////////////////////////////////////////////////////////////////////////////////
int _(Peek)()
{
  THROW (NEW (Exception)("Peek is not supported on process streams!"));

  return 0;
}

////////////////////////////////////////////////////////////////////////////////
int _(Get)()
{
  int c = getc(*BASE(2));

  BASE(1)->eos = c == EOF;

  return c;
}

////////////////////////////////////////////////////////////////////////////////
void _(Unget)(int c)
{
  THROW (NEW (Exception)("Unget is not supported on process streams!"));
}

////////////////////////////////////////////////////////////////////////////////
void _(Put)(int c)
{
  putc(c, *BASE(2));
}

#undef TYPENAME
